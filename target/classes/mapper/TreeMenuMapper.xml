<?xml version="1.0" encoding="UTF-8"?>
<!--该文件是对tree_menu表的查询等操作 author：张利红-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lonton.tree.treemenu.mapper.TreeMenuMapper">

    <resultMap type="com.lonton.tree.treemenu.pojo.TreeMenu" id="TreeMenuMap">
        <result property="menuId" column="menu_id"/>
        <result property="menuName" column="menu_name"/>
        <result property="parentMenuId" column="parent_menu_id"/>
        <result property="menuLevel" column="menu_level"/>
    </resultMap>

    <!--List<TreeMenu> getAllTreeMenu()-->
    <select id="getAllTreeMenu" resultType="com.lonton.tree.treemenu.pojo.TreeMenu">
        select
        menu_id, menu_name, parent_menu_id, menu_level
        from tree_menu
        <where>
            <if test="menuId != null">
                and menu_id = #{menuId}
            </if>
            <if test="menuName != null and menuName != ''">
                and name = #{name}
            </if>
            <if test="parentMenuId != null">
                and parent_menu_id = #{parentMenuId}
            </if>
            <if test="menuLevel != null">
                and menu_level = #{menuLevel}
            </if>
        </where>
        ORDER BY
        menu_id
    </select>

    <!--List<TreeMenu> getRootMenus()-->
    <select id="getRootMenus" resultType="com.lonton.tree.treemenu.pojo.TreeMenu">
        select
        menu_id, menu_name, parent_menu_id, menu_level
        from tree_menu
        <where>
            parent_menu_id = 0
        </where>
        ORDER BY
        menu_id
    </select>

    <!--List<TreeMenu> getChildren(@Param("menuId") Long menuId)-->
    <select id="getChildren" resultType="com.lonton.tree.treemenu.pojo.TreeMenu">
        select
        menu_id, menu_name, parent_menu_id, menu_level
        from tree_menu
        <where>
            parent_menu_id = #{menuId}
        </where>
        ORDER BY
        parent_menu_id ASC,menu_id ASC
    </select>

    <!--List<TreeMenu> buildTree();构建树形菜单-->
    <select id="buildTree" resultMap="TreeMenuMap">
        SELECT /*+INDEX(tree_menu tree_menu_idx) */
            menu_id,
            menu_name,
            parent_menu_id,
            menu_level
        FROM tree_menu
        ORDER BY menu_level
    </select>

    <!--List<TreeMenu> searchItems(String name);根据菜单名称进行搜索-->
    <select id="searchItems" resultMap="TreeMenuMap">
        WITH RECURSIVE tree AS (SELECT menu_id
                                     , menu_name
                                     , parent_menu_id
                                     , menu_level
                                FROM tree_menu
                                WHERE menu_name LIKE CONCAT('%', #{name}, '%')
                                UNION ALL
                                SELECT t1.menu_id, t1.menu_name, t1.parent_menu_id, t1.menu_level
                                FROM tree_menu t1
                                         INNER JOIN
                                     tree ON t1.menu_id = tree.parent_menu_id)
        SELECT menu_id
             , menu_name
             , parent_menu_id
             , menu_level
        FROM tree
        ORDER BY menu_level, menu_id
    </select>

</mapper>

